# Risk Profile: Story 1.2

Date: 2025-09-09
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5
- Critical Risks: 1
- High Risks: 0  
- Medium Risks: 3
- Low Risks: 1
- Risk Score: 78/100 (Good - One critical issue requiring immediate attention)

## Critical Risks Requiring Immediate Attention

### 1. SEC-002: Authentication Bypass Risk

**Score: 9 (Critical)**
**Probability**: High (3) - Current hardcoded household ID in API route (line 38)
**Impact**: High (3) - Complete unauthorized data access to any household's inventory
**Affected Components**: 
- `app/api/v1/items/route.ts:38`
- `app/api/v1/locations/route.ts` (similar pattern expected)

**Mitigation**:
- **IMMEDIATE**: Implement proper household context resolution from user session
- **IMMEDIATE**: Add user-household permission validation middleware  
- **IMMEDIATE**: Remove hardcoded `householdId = 'household-1'` placeholder

**Technical Implementation Recommendations:**

1. **Extend NextAuth Session** - Add household context to JWT token:
```typescript
// lib/auth/config.ts - Update callbacks
callbacks: {
  jwt({ token, user }) {
    if (user) {
      token.id = user.id;
      token.householdId = user.defaultHouseholdId; // Add this
    }
    return token;
  },
  session({ session, token }) {
    if (token?.id) {
      session.user.id = token.id as string;
      session.user.householdId = token.householdId as string; // Add this
    }
    return session;
  },
}
```

2. **Create Household Resolution Utility**:
```typescript
// lib/utils/household-context.ts
export async function getHouseholdContext(session: Session): Promise<string> {
  if (!session?.user?.householdId) {
    throw new PermissionError('No household context available');
  }
  
  // Verify user still has access to household
  const hasAccess = await prisma.household.findFirst({
    where: { 
      id: session.user.householdId,
      users: { some: { id: session.user.id } }
    }
  });
  
  if (!hasAccess) {
    throw new PermissionError('Household access revoked');
  }
  
  return session.user.householdId;
}
```

3. **Update API Routes Pattern**:
```typescript
// app/api/v1/items/route.ts - Replace lines 36-38
const session = await auth();
if (!session?.user?.id) {
  return Response.json(createErrorResponse('UNAUTHORIZED'), { status: 401 });
}

const householdId = await getHouseholdContext(session);
```

**Testing Focus**: 
- Test cross-household data access prevention
- Validate all API endpoints enforce household isolation
- Penetration testing for privilege escalation

## Risk Distribution

### By Category
- Security: 1 risk (1 critical)
- Technical: 1 risk (0 critical)
- Performance: 1 risk (0 critical)  
- Data: 1 risk (0 critical)
- Operational: 1 risk (0 critical)

### By Component
- Backend API: 3 risks (1 critical)
- Database: 2 risks (0 critical)
- Infrastructure: 0 risks

## Detailed Risk Register

| Risk ID  | Category | Description                           | Probability | Impact | Score | Priority |
|----------|----------|---------------------------------------|-------------|--------|-------|----------|
| SEC-002  | Security | Hardcoded household ID bypass        | High (3)    | High (3) | 9   | Critical |
| TECH-001 | Technical| Database performance degradation      | Medium (2)  | Medium (2) | 4 | Medium   |
| PERF-004 | Performance| File upload timeout issues          | Medium (2)  | Medium (2) | 4 | Medium   |
| DATA-003 | Data     | Migration data loss potential         | Low (1)     | High (3) | 3   | Low      |
| OPS-005  | Operational| Database monitoring gaps            | Medium (2)  | Low (1)  | 2   | Low      |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **SEC-002 Authentication Bypass**:
  - Test unauthorized household access attempts
  - Verify user can only access their own household data
  - Test session hijacking scenarios
  - Validate JWT token household claims

### Priority 2: Medium Risk Tests  
- **TECH-001 Performance**: Load testing with 1000+ items per household
- **PERF-004 File Uploads**: Test large file uploads (>50MB), timeout handling

### Priority 3: Low Risk Tests
- **DATA-003**: Test migration rollback procedures
- **OPS-005**: Validate error logging and alerting

## Risk Acceptance Criteria

### Must Fix Before Production
- **SEC-002**: Critical authentication bypass - FAIL gate if unresolved

### Can Deploy with Mitigation
- **TECH-001, PERF-004**: Medium risks acceptable with monitoring
- **DATA-003, OPS-005**: Low risks acceptable with documented procedures

## Monitoring Requirements

Post-deployment monitoring for:
- **Security**: Failed authentication attempts, cross-household access attempts  
- **Performance**: API response times >200ms, database query times >100ms
- **Error Rates**: 4xx/5xx API responses, database connection failures
- **Business KPIs**: Item creation success rate, search query performance

## Risk Review Triggers

Review and update risk profile when:
- Household permission system changes
- Database schema modifications
- New API endpoints added
- Security vulnerabilities discovered in dependencies
- Performance degradation reported in production