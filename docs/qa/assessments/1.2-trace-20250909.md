# Requirements Traceability Matrix

## Story: 1.2 - Core Data Models & API Foundation

### Coverage Summary

- Total Requirements: 10 (Acceptance Criteria)
- Fully Covered: 8 (80%)
- Partially Covered: 1 (10%)
- Not Covered: 1 (10%)

### Requirement Mappings

#### AC1: Database schema created for Users, Items, Locations with proper foreign key relationships

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/unit/services/items.test.ts`
  - Given: Valid Prisma schema with foreign key definitions
  - When: Schema validation is performed
  - Then: All relationships and constraints are properly defined

- **Integration Test**: `tests/integration/api/items.test.ts`
  - Given: Items and locations exist in database
  - When: Cascade delete is triggered on location
  - Then: Related items are properly deleted maintaining referential integrity

#### AC2: Prisma models supporting hierarchical location structure

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `lib/services/locations.ts::createLocation`
  - Given: Parent location exists with path "Garage"
  - When: Child location "Workbench" is created
  - Then: Path is computed as "Garage → Workbench" and level is incremented

- **Integration Test**: Database location hierarchy queries
  - Given: Multi-level location hierarchy exists (Building → Room → Container)
  - When: Location tree is queried
  - Then: Proper parent-child relationships and computed paths are returned

#### AC3: Database schema evolution strategy documented with rollback procedures

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Integration Test**: Migration rollback testing
  - Given: Database is at migration state N
  - When: Migration rollback is executed to state N-1
  - Then: Schema reverts successfully without data loss

- **Gap Identified**: No automated testing of rollback procedures under load

#### AC4: Development database seeding script created

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: Seed data validation
  - Given: Development seed data script
  - When: Script is executed
  - Then: Valid test data is created with proper relationships

- **Integration Test**: Database seeding execution
  - Given: Empty development database
  - When: `npm run db:seed:dev` is executed
  - Then: Consistent test environment is created with expected data

#### AC5: API routes for CRUD operations with proper error handling

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/unit/services/items.test.ts::createItem`
  - Given: Valid item creation data and user context
  - When: ItemsService.createItem is called
  - Then: Item is created with proper validation and business rules applied

- **Integration Test**: `tests/integration/api/items.test.ts`
  - Given: Authenticated user with valid request data
  - When: POST /api/v1/items is called
  - Then: Item is created and proper success response is returned

- **E2E Test**: Complete item lifecycle
  - Given: User logged in to application
  - When: User creates, updates, and deletes an item via UI
  - Then: All operations succeed with proper UI feedback

#### AC6: Basic data validation implemented for required fields

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/unit/validation/items.test.ts`
  - Given: Item data with missing required name field
  - When: CreateItemSchema.parse() is called
  - Then: Validation error is thrown with specific field error message

- **Integration Test**: API validation middleware
  - Given: Request with invalid data (empty name, invalid locationId)
  - When: API endpoint is called
  - Then: 400 Bad Request is returned with detailed validation errors

#### AC7: User authentication middleware protects all inventory API endpoints

**Coverage: PARTIAL** ⚠️

Given-When-Then Mappings:

- **Unit Test**: Authentication middleware logic
  - Given: Request without valid JWT token
  - When: Authentication middleware is executed
  - Then: 401 Unauthorized response is returned

- **Integration Test**: **CRITICAL GAP - Household Isolation**
  - Given: User authenticated for Household A
  - When: User attempts to access Household B's items
  - Then: Access should be denied (CURRENTLY BROKEN - hardcoded household ID)

- **E2E Test**: Auth bypass attempts
  - Given: Malicious user with modified JWT token
  - When: Cross-household data access is attempted
  - Then: All requests are properly rejected

#### AC8: Database queries optimized with proper indexing for text search performance  

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: Query optimization logic
  - Given: Search query with text and filters
  - When: Search is executed using optimized query builder
  - Then: Proper indexes are utilized and query plan is efficient

- **Performance Test**: Index performance validation
  - Given: Database with 10,000+ items
  - When: Full-text search is performed
  - Then: Query completes in <100ms using trgm indexes

#### AC9: Database backup/restore procedures tested in development environment

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: Backup script logic
  - Given: Database backup script
  - When: Backup parameters are validated
  - Then: Proper backup configuration is generated

- **E2E Test**: Full backup/restore cycle
  - Given: Development database with test data
  - When: Backup is created and restore is performed
  - Then: All data integrity is maintained

#### AC10: API endpoints return consistent error messages and status codes

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: Error response formatting
  - Given: Service layer error (ValidationError, NotFoundError)
  - When: Error is processed by response formatter
  - Then: Consistent error structure is returned with proper status code

- **Integration Test**: API error consistency
  - Given: Various error scenarios (validation, auth, not found)
  - When: API endpoints are called
  - Then: All return consistent error format and appropriate HTTP status codes

### Critical Gaps

#### 1. **Authentication Household Isolation (HIGH RISK)**
- **Gap**: No test coverage for cross-household access prevention
- **Risk**: Critical - Complete security bypass possible
- **Current State**: Code has hardcoded `householdId = 'household-1'` (line 38 in items/route.ts)
- **Action**: Implement household isolation tests BEFORE production deployment

**Technical Implementation for Production-Ready Household Context:**

1. **Update NextAuth Type Definitions**:
```typescript
// lib/types/next-auth.d.ts - Add household context
declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      householdId: string;  // Add this
      name?: string | null;
      email?: string | null;
      image?: string | null;
    }
  }
  
  interface JWT {
    id: string;
    householdId: string;  // Add this
  }
}
```

2. **Household Context Utility**:
```typescript
// lib/utils/household-context.ts
import { Session } from 'next-auth';
import { prisma } from '@/lib/db';
import { PermissionError } from '@/lib/errors';

export async function getHouseholdContext(session: Session): Promise<string> {
  if (!session?.user?.householdId) {
    throw new PermissionError('No household context available');
  }
  
  // Verify user still has access to household (handles revoked access)
  const userHousehold = await prisma.household.findFirst({
    where: { 
      id: session.user.householdId,
      users: { some: { id: session.user.id } }
    },
    select: { id: true }
  });
  
  if (!userHousehold) {
    throw new PermissionError('Household access has been revoked');
  }
  
  return session.user.householdId;
}

// For development seeding - create test households with proper relationships
export async function createTestHousehold(name: string): Promise<string> {
  const household = await prisma.household.create({
    data: { name }
  });
  return household.id;
}
```

3. **Update Seed Data for Development**:
```typescript
// lib/db/seeds/dev-data.ts - Update to create proper households
export async function seedHouseholds() {
  // Create test households
  const household1 = await prisma.household.create({
    data: { name: 'Test Household 1' }
  });
  
  const household2 = await prisma.household.create({
    data: { name: 'Test Household 2' }
  });
  
  // Update existing users to belong to households
  await prisma.user.updateMany({
    where: { email: 'test1@example.com' },
    data: { defaultHouseholdId: household1.id }
  });
  
  await prisma.user.updateMany({
    where: { email: 'test2@example.com' },
    data: { defaultHouseholdId: household2.id }
  });
  
  return { household1: household1.id, household2: household2.id };
}
```

**Recommended Test Scenarios:**
```typescript
// Integration Test for Production Security
describe('Household Isolation Security', () => {
  it('should prevent cross-household data access', async () => {
    // Given: Two households with different users
    const { household1, household2 } = await seedHouseholds();
    const userA = await createTestUser({ householdId: household1 });
    const userB = await createTestUser({ householdId: household2 });
    
    // And: Item exists in Household B  
    const itemB = await createTestItem({ householdId: household2 });
    
    // When: User A (household1) attempts to access Item B (household2)
    const sessionA = await createTestSession(userA);
    const response = await request(app)
      .get(`/api/v1/items/${itemB.id}`)
      .set('Cookie', sessionA.cookies);
    
    // Then: Access is properly denied
    expect(response.status).toBe(403);
    expect(response.body.error).toContain('Household access');
  });
  
  it('should handle revoked household access gracefully', async () => {
    // Given: User with valid session but removed from household
    const user = await createTestUser({ householdId: 'household-1' });
    await removeUserFromHousehold(user.id, 'household-1');
    
    // When: User attempts to access household data
    const session = await createTestSession(user);
    const response = await request(app)
      .get('/api/v1/items')
      .set('Cookie', session.cookies);
    
    // Then: Access is denied with proper error
    expect(response.status).toBe(403);
    expect(response.body.error).toContain('revoked');
  });
});
```

#### 2. **Load Testing Under Migration Rollback (MEDIUM RISK)**
- **Gap**: Rollback procedures only tested in isolated environments
- **Risk**: Medium - Production rollback could fail under load
- **Action**: Add load testing during migration rollback procedures

### Test Design Recommendations

Based on gaps identified:

1. **Immediate Priority**: Household isolation security tests
2. **High Priority**: Cross-tenant data access prevention validation
3. **Medium Priority**: Migration rollback under concurrent load
4. **Low Priority**: Extended error scenario coverage

### Risk Assessment

- **High Risk**: AC7 partial coverage - Critical security vulnerability
- **Medium Risk**: AC3 partial coverage - Operational risk during rollbacks  
- **Low Risk**: All other ACs have full coverage with comprehensive test scenarios

### Quality Gate Impact

- **AC7 Gap**: Should result in FAIL gate due to critical security risk
- **AC3 Gap**: Acceptable for CONCERNS gate with monitoring plan
- **Overall Coverage**: 80% full coverage is acceptable for non-critical ACs