# Test Design: Story 1.3

Date: 2025-09-09
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 32
- Unit tests: 18 (56%)
- Integration tests: 10 (31%)
- E2E tests: 4 (13%)
- Priority distribution: P0: 12, P1: 16, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: "Add Item" form allows entry of item name, description, location, and optional quantity/value

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-001 | Unit        | P0       | Form validation logic                 | Pure validation rules testing    |
| 1.3-UNIT-002 | Unit        | P0       | React 19 useActionState hook behavior | New React pattern validation     |
| 1.3-INT-001  | Integration | P0       | Form submission to API endpoints      | Full form-to-server flow         |
| 1.3-E2E-001  | E2E         | P1       | Complete item creation user journey   | Critical user workflow           |

### AC2: Basic photo upload functionality using simple file input

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-003 | Unit        | P0       | **CRITICAL**: File validation logic   | Security risk mitigation (SEC-003) |
| 1.3-UNIT-004 | Unit        | P0       | File type and size validation         | Input sanitization testing      |
| 1.3-UNIT-005 | Unit        | P1       | Drag-drop functionality               | User interaction logic           |
| 1.3-INT-002  | Integration | P0       | **CRITICAL**: File upload security    | Malicious file upload prevention |
| 1.3-INT-003  | Integration | P1       | Photo processing pipeline             | Sharp.js integration testing     |

### AC3: Image preview displays before save with basic client-side validation

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-006 | Unit        | P1       | Image preview component rendering     | UI component logic               |
| 1.3-UNIT-007 | Unit        | P1       | Client-side validation rules          | Frontend validation logic        |
| 1.3-INT-004  | Integration | P1       | Preview with actual file processing   | File handling integration        |

### AC4: Single photo per item supported for MVP validation

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-008 | Unit        | P1       | Single photo constraint enforcement   | Business rule validation         |
| 1.3-INT-005  | Integration | P1       | Photo replacement functionality       | State management testing         |

### AC5: Photos stored temporarily in local filesystem with organized file structure

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-009 | Unit        | P0       | **CRITICAL**: Secure file path generation | Directory traversal prevention |
| 1.3-UNIT-010 | Unit        | P1       | File organization logic               | Storage structure validation     |
| 1.3-INT-006  | Integration | P1       | Local filesystem operations           | File I/O integration testing     |
| 1.3-INT-007  | Integration | P2       | Storage cleanup for deleted items     | Resource management testing      |

### AC6: Location selector supports hierarchical structure with ability to create new locations

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-011 | Unit        | P1       | Location hierarchy display logic      | Tree structure rendering         |
| 1.3-UNIT-012 | Unit        | P1       | New location creation validation      | Form input validation            |
| 1.3-INT-008  | Integration | P1       | Location selector API integration     | Backend service connection       |

### AC7: Form validation provides clear error messages for missing required fields

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-013 | Unit        | P0       | Error message generation logic        | User feedback validation         |
| 1.3-UNIT-014 | Unit        | P1       | Field-specific validation rules       | Individual validation logic      |
| 1.3-E2E-002  | E2E         | P1       | Error message display in UI           | End-to-end error handling        |

### AC8: Items successfully save to database with proper user association

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-015 | Unit        | P0       | Server action validation logic        | React 19 server action testing  |
| 1.3-INT-009  | Integration | P0       | Database persistence with API         | Full data flow validation        |

### AC9: Basic item list displays added items with name, description, location, and photo thumbnail

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-016 | Unit        | P1       | Item card component rendering         | UI component testing             |
| 1.3-UNIT-017 | Unit        | P1       | Thumbnail optimization logic          | Image processing validation      |
| 1.3-INT-010  | Integration | P1       | Item list data fetching               | API integration testing          |

### AC10: Items can be edited and deleted through simple interface actions

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-UNIT-018 | Unit        | P1       | Edit/delete action handlers           | User interaction logic           |
| 1.3-E2E-003  | E2E         | P1       | Complete edit/delete workflows        | Critical user operations         |

### AC11: Mobile-responsive design works well on smartphone screens for inventory building

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------- | -------------------------------- |
| 1.3-E2E-004  | E2E         | P0       | **CRITICAL**: Mobile inventory workflow | Business risk mitigation (BUS-001) |

### AC12: Photo upload works reliably on both desktop and mobile browsers

#### Scenarios

Cross-device testing covered in mobile E2E scenarios above.

## Risk Coverage

**Critical Security Risk (SEC-003) Coverage:**
- 1.3-UNIT-003: File validation logic testing
- 1.3-UNIT-004: File type and size validation  
- 1.3-UNIT-009: Secure file path generation
- 1.3-INT-002: File upload security integration testing

**Performance Risk (PERF-005/006) Coverage:**
- 1.3-INT-003: Photo processing performance testing
- 1.3-INT-006: Local filesystem performance
- 1.3-INT-007: Storage cleanup efficiency

**Business Risk (BUS-001) Coverage:**
- 1.3-E2E-004: Mobile inventory workflow testing

**Technical Risk (TECH-002) Coverage:**
- 1.3-UNIT-002: React 19 useActionState testing
- 1.3-UNIT-015: React 19 server action validation

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Critical Foundation)
1. 1.3-UNIT-001 - Form validation logic
2. 1.3-UNIT-002 - React 19 useActionState behavior
3. 1.3-UNIT-003 - **CRITICAL**: File validation logic
4. 1.3-UNIT-004 - File security validation
5. 1.3-UNIT-009 - **CRITICAL**: Secure file paths
6. 1.3-UNIT-013 - Error message generation
7. 1.3-UNIT-015 - Server action validation

### Phase 2: P0 Integration Tests (Critical Security)
8. 1.3-INT-001 - Form submission integration
9. 1.3-INT-002 - **CRITICAL**: File upload security
10. 1.3-INT-009 - Database persistence validation

### Phase 3: P0 E2E Tests (Critical Mobile Experience)
11. 1.3-E2E-004 - **CRITICAL**: Mobile inventory workflow

### Phase 4: P1 Tests (Important Features)
12-27. All P1 unit, integration, and E2E tests

### Phase 5: P2 Tests (Secondary Features)
28-32. All P2 tests as time permits

## Test Data Requirements

### File Upload Security Testing
- **Malicious Files**: Executable files (.exe, .bat, .sh), script files (.js, .php)
- **Oversized Files**: Files >10MB, edge case sizes (exactly 10MB)
- **Invalid Formats**: Non-image files with image extensions
- **Corrupted Images**: Malformed headers, truncated files
- **Directory Traversal**: Filenames with "../", absolute paths

### Form Validation Testing
- **Required Fields**: Empty name, missing location
- **Edge Cases**: Very long names (>200 chars), special characters
- **Boundary Values**: Quantity 0, negative values, decimal quantities
- **Unicode Support**: International characters, emojis in descriptions

### Mobile Testing Data
- **Device Variations**: iPhone, Android, tablet screen sizes
- **Touch Gestures**: Tap, drag-drop, pinch-zoom on images
- **Network Conditions**: Slow 3G, intermittent connectivity
- **Storage Scenarios**: Limited device storage, app backgrounding

### React 19 Hook Testing
- **State Transitions**: Pending → Success, Pending → Error
- **Concurrent Updates**: Multiple form submissions, race conditions
- **Error Scenarios**: Network failures, validation failures
- **Optimistic Updates**: UI state during async operations

## Component-Specific Test Scenarios

### PhotoUpload Component
```typescript
// Test malicious file upload prevention
describe('PhotoUpload Security', () => {
  test('rejects executable files', () => {
    const mockFile = new File([''], 'malware.exe', { type: 'application/x-msdownload' });
    expect(validateImageFile(mockFile)).toEqual({
      valid: false,
      error: 'Invalid file type. Only JPEG, PNG, and WebP allowed.'
    });
  });
  
  test('enforces file size limits', () => {
    const oversizedFile = createMockFile(15 * 1024 * 1024); // 15MB
    expect(validateImageFile(oversizedFile)).toEqual({
      valid: false,
      error: 'File size too large. Maximum 10MB allowed.'
    });
  });
});
```

### ItemForm Component  
```typescript
// Test React 19 useActionState integration
describe('ItemForm React 19 Integration', () => {
  test('handles form submission with useActionState', async () => {
    const { getByLabelText, getByRole } = render(<ItemForm />);
    
    await user.type(getByLabelText(/item name/i), 'Test Item');
    await user.click(getByRole('button', { name: /save/i }));
    
    expect(mockCreateItemAction).toHaveBeenCalledWith(expect.any(FormData));
  });
});
```

### LocationSelector Component
```typescript
// Test hierarchical location display
describe('LocationSelector', () => {
  test('displays location hierarchy correctly', () => {
    const locations = [
      { id: '1', name: 'Garage', path: 'Garage', parentId: null },
      { id: '2', name: 'Workbench', path: 'Garage → Workbench', parentId: '1' }
    ];
    
    render(<LocationSelector locations={locations} />);
    expect(screen.getByText('Garage → Workbench')).toBeInTheDocument();
  });
});
```

## Performance Testing Scenarios

### Image Processing Performance
- Test Sharp.js processing with various image sizes (1MB, 5MB, 10MB)
- Measure thumbnail generation time (target: <2 seconds)
- Test concurrent image processing (multiple uploads)
- Validate memory usage during processing

### Mobile Performance
- Test form rendering time on low-end devices
- Measure photo upload progress on slow networks
- Validate UI responsiveness during background processing
- Test storage space monitoring and cleanup

## Security Testing Scenarios

### File Upload Security
- **Content Type Spoofing**: Files with wrong MIME types
- **Double Extension**: Files like `image.jpg.exe`
- **Null Byte Injection**: Filenames with null bytes
- **Path Traversal**: `../../../etc/passwd` in filenames
- **Zip Bombs**: Malicious compressed images
- **Polyglot Files**: Files valid as both image and script

### Input Validation Security
- **XSS Prevention**: Script tags in item descriptions
- **SQL Injection**: Special characters in form fields
- **Command Injection**: Shell commands in filenames
- **Unicode Attacks**: Homograph attacks in item names

## Quality Checklist

Before finalizing, verify:

- [x] Every AC has comprehensive test coverage
- [x] Critical security risks (SEC-003) have P0 test coverage
- [x] React 19 specific functionality is thoroughly tested
- [x] Mobile responsiveness has dedicated E2E testing
- [x] File upload security has multi-layer testing (unit + integration)
- [x] Performance risks are addressed with appropriate testing
- [x] Test scenarios are atomic and independent
- [x] Test data covers security, performance, and UX edge cases